{% extends "base/base.html" %}
{% block main %}
<div style="padding: 1px; width:70px; margin-bottom: 10px; border: 1px solid #686666;">
<h5>これまでの参戦</h5>
</div>
<div style="padding: 1px; width:70px; margin-bottom: 10px; border: 1px solid #686666;">
<h5>今年参戦</h5>
</div>
<div style="padding: 1px; width:70px; margin-bottom: 10px; border: 1px solid #686666;">
<h5>参戦予定</h5>
</div>
<div id="date1"class="date"></div>
<input name="start-date" type="date"/><h6>~</h6><input name="end-date" type="date"/>
<p><select name="font" size=1>
    <option value="フォント選択">フォントを選択</option>
    <option value="ヒラギノ角ゴシック">ヒラギノ角ゴシック</option>
    <option value="Noto Sans">Noto Sans</option>
    <option value="Noto Serif">Noto Serif</option>
    <option value="M Plus 1p">M Plus 1p</option>
    <option value="Oswald">Oswald</option>
    <option value="Roboto">Roboto</option>
</select></p>

<p><select name="color" size=1>
    <option value="色を選択">色を選択</option>
    <option value="#000000">黒</option>
    <option value="#c0c0c0">グレー</option>
    <option value="#ffffff">白</option>
    <option value="#ff0000">赤</option>
    <option value="#ff00ff">ピンク</option>
    <option value="#ffff00">黄</option>
    <option value="#00ff00">緑</option>
    <option value="#0000ff">青</option>
</select></p>

<!-- モーダルウィンドウの内容 -->
<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#BackImageModal">
  背景画像を選択
</button>

<!-- Modal -->
<div class="modal fade" id="BackImageModal" tabindex="-1" aria-labelledby="BackImageModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">

      <div id="modal-menu-view">
        <div class="modal-header">
          <h5 class="modal-title" id="BackImageModalLabel">背景画像を選択</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-4">
            <label class="btn btn-outline-dark w-100 py-2 mb-2">カメラロールから選択</label>
            <input type="file"; class="d-done"; accept="image/*"; id="user-image" >
          </div>
          <hr>
            <button type="button" class="btn btn-outline-primary w-100" id="presetimage">アプリ内の画像から選択</button>
        </div>
   
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
        </div>
      </div>


        <div id="modal-preset-view" style="display:none;">
          <div class="modal-header">
            <button type="button" class="btn btn-smbtn-secondary me-2" id="btn-back-to-menu">＜戻る</button>
            <h5 class="modal-title">アプリ内の画像から選択</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>    
          <div class="d-flex flex-wrap gap-2"; id=preset-image-list>
            {% for img_obj in presetimage %}
              <img src="{{ img_obj.preset_image_url.url }}" class="preset-option" style="width:calc(50% - 5px);aspect-ratio:1/1; object-fit:cover; cursor:pointer;">
            {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>
<div id="selected-preview" style="display:none;">
    <p>選択中の画像:</p>
    <img id="current-bg-thumbnail" src="" style="width:100px; border:2px solid #5f5f5f;">
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const btnShowPresets = document.getElementById('presetimage'); 
    const btnBackToMenu = document.getElementById('btn-back-to-menu');
    const menuView = document.getElementById('modal-menu-view');
    const presetView = document.getElementById('modal-preset-view');

    // 「アプリ内の画像から選択（id="presetimage"）」ボタンが押されたとき
    if (btnShowPresets) {
        btnShowPresets.addEventListener('click', function() {
            menuView.style.display = 'none';   // メニュー画面を消す
            presetView.style.display = 'block'; // 画像一覧画面を出す
        });
    }

    // 「戻る」ボタンが押されたとき
    if (btnBackToMenu) {
        btnBackToMenu.addEventListener('click', function() {
            presetView.style.display = 'none';  // 画像一覧画面を消す
            menuView.style.display = 'block';   // メニュー画面を出す
        });
    }

    // モーダルを閉じたときに表示を最初に戻す設定
    const myModal = document.getElementById('BackImageModal');
    if (myModal) {
        myModal.addEventListener('hidden.bs.modal', function () {
            menuView.style.display = 'block';
            presetView.style.display = 'none';
        });
    }
});

// 1. 共通の「プレビューを表示してモーダルを閉じる」命令を作る
function updatePreview(url) {
    const previewImg = document.getElementById('current-bg-thumbnail');
    const previewContainer = document.getElementById('selected-preview');

    if (previewImg) previewImg.src = url;
    if (previewContainer) previewContainer.style.display = 'block';
    
    // 背景にも反映
    //document.body.style.backgroundImage = `url('${url}')`;

    // モーダルを閉じる
    const modal = bootstrap.Modal.getInstance(document.getElementById('BackImageModal'));
    if (modal) modal.hide();
}

// 2. アプリ内画像をクリックしたとき
document.querySelectorAll('.preset-option').forEach(img => {
    img.addEventListener('click', () => updatePreview(img.src));
});

// 3. 【カメラロール】から選んだとき
document.getElementById('user-image').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (event) => updatePreview(event.target.result);
        reader.readAsDataURL(file);
    }
});

</script>
{% endblock %}